name: release-from-pi-gen

on:
  workflow_run:
    workflows: ["build-pi-gen-lite"]
    types: [completed]

permissions:
  contents: write

jobs:
  create-release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (for docs and changelog)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifacts from build run
        uses: dawidd6/action-download-artifact@v3
        with:
          run_id: ${{ github.event.workflow_run.id }}
          path: artifacts
          if_no_artifact_found: ignore

      - name: Collect OpenCarDev images only
        id: collect
        run: |
          set -euo pipefail
          mkdir -p release_assets
          shopt -s nullglob
          # Find images with -opencardev suffix
          found=0
          for f in artifacts/**/deploy/*-opencardev*.{xz,zip,img}; do
            cp -v "$f" release_assets/
            found=1
          done || true

          if [ "$found" -eq 0 ]; then
            echo "No *-opencardev images found in artifacts. Aborting." >&2
            exit 1
          fi

          # Derive build metadata from artifact directory names
          # Expect artifact dir names like: pi-gen-lite-<arch>-<builddate>-<version>
          arches=()
          builddate=""
          version=""
          for dir in artifacts/*; do
            bname=$(basename "$dir")
            # Split on '-' and try to parse
            IFS='-' read -r prefix arch bd ver <<<"$bname"
            if [ "$prefix" = "pi" ]; then
              # handle names with 'pi-gen-lite' prefix (pi-gen-lite is 3 tokens when split by '-')
              IFS='-' read -r p1 p2 p3 arch bd ver <<<"$bname"
            fi
            if [ -n "${arch:-}" ]; then
              arches+=("$arch")
            fi
            if [ -z "$builddate" ] && [ -n "${bd:-}" ]; then
              builddate="$bd"
            fi
            if [ -z "$version" ] && [ -n "${ver:-}" ]; then
              version="$ver"
            fi
          done

          # Fallbacks
          if [ -z "$builddate" ]; then builddate=$(date +%Y-%m-%d); fi
          if [ -z "$version" ]; then version="DEV"; fi

          # Tag and name
          tag="pi-gen-lite-${builddate}-${version}"
          name="Pi-gen Lite ${builddate} (${version})"

          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "name=$name" >> "$GITHUB_OUTPUT"
          echo "builddate=$builddate" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          printf '%s\n' "${arches[@]}" | sort -u | tr '\n' ',' | sed 's/,$//' | awk '{print "arches=" $0}' >> "$GITHUB_OUTPUT"

      - name: Compute SHA256 checksums
        run: |
          set -euo pipefail
          cd release_assets
          sha256sum * > SHA256SUMS-opencardev.txt
          # Also write individual .sha256 files
          while read -r sum file; do
            echo "$sum  $file" > "$file.sha256"
          done < SHA256SUMS-opencardev.txt

      - name: Install SBOM tooling (syft + guestmount)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools xz-utils unzip
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
          syft --version

      - name: Generate CycloneDX/SPDX SBOMs from images
        run: |
          set -euo pipefail
          export LIBGUESTFS_BACKEND=direct
          mkdir -p sbom_tmp mnt
          shopt -s nullglob
          for src in release_assets/*-opencardev*; do
            base=$(basename "$src")
            img=""
            tmp_created=0
            case "$base" in
              *.img)
                img="$src"
                ;;
              *.img.xz)
                out="sbom_tmp/${base%.xz}"
                echo "Decompressing $src -> $out"
                xz -dkc "$src" > "$out"
                img="$out"
                tmp_created=1
                ;;
              *.zip)
                echo "Extracting .img from $src"
                mkdir -p sbom_tmp/unzip
                unzip -j -o "$src" '*.img' -d sbom_tmp/unzip >/dev/null
                img=$(ls sbom_tmp/unzip/*.img 2>/dev/null | head -n 1 || true)
                if [ -z "$img" ]; then
                  echo "No .img found inside $src, skipping" >&2
                  continue
                fi
                tmp_created=1
                ;;
              *)
                echo "Unsupported artifact type: $base, skipping" >&2
                continue
                ;;
            esac

            echo "Mounting $img read-only via guestmount"
            sudo guestmount -a "$img" -i --ro mnt || { echo "guestmount failed for $img" >&2; [ "$tmp_created" -eq 1 ] && rm -f "$img"; continue; }

            # Generate SBOMs
            cdx="release_assets/${base%.xz}.sbom.cyclonedx.json"
            spdx="release_assets/${base%.xz}.sbom.spdx.json"
            echo "Generating CycloneDX -> $cdx"
            syft dir:mnt -o cyclonedx-json > "$cdx" || echo "Failed to create CycloneDX SBOM for $base"
            echo "Generating SPDX -> $spdx"
            syft dir:mnt -o spdx-json > "$spdx" || echo "Failed to create SPDX SBOM for $base"

            # Optionally extract the embedded versions file from boot
            if [ -f mnt/boot/opencardev/versions.txt ]; then
              cp mnt/boot/opencardev/versions.txt "release_assets/${base%.xz}.versions.txt" || true
            fi

            # Unmount and cleanup
            sudo guestunmount mnt || true
            sudo rm -rf mnt/*
            if [ "$tmp_created" -eq 1 ]; then rm -f "$img"; fi
          done

      - name: Read versions and SBOM from artifacts (preferred)
        id: versions
        run: |
          set -euo pipefail
          # Look for metadata files uploaded by the build job
          VFILE=$(ls artifacts/**/opencardev/versions.txt 2>/dev/null | head -n 1 || true)
          SBOM=$(ls artifacts/**/opencardev/sbom-packages.txt 2>/dev/null | head -n 1 || true)
          if [ -n "${VFILE}" ]; then
            echo "Found versions file: ${VFILE}"
            # Emit each line as output key=value if matches expected keys
            libaasdk=$(grep '^libaasdk=' "${VFILE}" | cut -d= -f2- || echo "n/a")
            openauto=$(grep '^openauto=' "${VFILE}" | cut -d= -f2- || echo "n/a")
            echo "libaasdk=${libaasdk}" >> "$GITHUB_OUTPUT"
            echo "openauto=${openauto}" >> "$GITHUB_OUTPUT"
          else
            echo "No versions.txt found in artifacts; will fall back to repo metadata."
          fi
          if [ -n "${SBOM}" ]; then
            echo "sbom_path=${SBOM}" >> "$GITHUB_OUTPUT"
          fi

      - name: Resolve libaasdk/openauto versions from repo metadata (fallback)
        id: pkgver
        run: |
          set -euo pipefail
          # If versions.txt is present, prefer those single values (no per-arch distinction)
          if [ -n "${{ steps.versions.outputs.libaasdk }}" ] || [ -n "${{ steps.versions.outputs.openauto }}" ]; then
            echo "Found versions in artifacts; skipping repo metadata lookup."
            echo "libaasdk_armhf=${{ steps.versions.outputs.libaasdk || 'n/a' }}" >> "$GITHUB_OUTPUT"
            echo "libaasdk_arm64=${{ steps.versions.outputs.libaasdk || 'n/a' }}" >> "$GITHUB_OUTPUT"
            echo "openauto_armhf=${{ steps.versions.outputs.openauto || 'n/a' }}" >> "$GITHUB_OUTPUT"
            echo "openauto_arm64=${{ steps.versions.outputs.openauto || 'n/a' }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          release=trixie
          # Try both arches to report available versions
          get_ver() {
            pkg="$1"; arch="$2";
            url="https://opencardev.github.io/packages/dists/${release}/main/binary-${arch}/Packages"
            ver=$(curl -fsSL "$url" | awk -v p="Package: ${pkg}" -v f="Version:" '
              $0==p {found=1} found&&/^Version:/ {print $2; exit}
            ')
            echo "${ver:-n/a}"
          }
          libaasdk_armhf=$(get_ver libaasdk armhf)
          libaasdk_arm64=$(get_ver libaasdk arm64)
          openauto_armhf=$(get_ver openauto armhf)
          openauto_arm64=$(get_ver openauto arm64)

          echo "libaasdk_armhf=$libaasdk_armhf" >> "$GITHUB_OUTPUT"
          echo "libaasdk_arm64=$libaasdk_arm64" >> "$GITHUB_OUTPUT"
          echo "openauto_armhf=$openauto_armhf" >> "$GITHUB_OUTPUT"
          echo "openauto_arm64=$openauto_arm64" >> "$GITHUB_OUTPUT"

      - name: Build release notes
        run: |
          set -euo pipefail
          install_doc_url="https://github.com/${{ github.repository }}/blob/main/docs/INSTALLATION.md"

          echo "# Release ${{ steps.collect.outputs.name }}" > release_notes.md
          echo >> release_notes.md
          echo "This release bundles Raspberry Pi images built by pi-gen with OpenCarDev customisations (stage60)." >> release_notes.md
          echo >> release_notes.md
          echo "## Artifacts (-opencardev only)" >> release_notes.md
          echo >> release_notes.md
          ls -lh release_assets/* | awk '{printf("- %s (%s)\n", $9, $5)}' >> release_notes.md || true
          echo >> release_notes.md
          echo "## SHA256 checksums" >> release_notes.md
          echo >> release_notes.md
          echo '\`\`\`' >> release_notes.md
          cat release_assets/SHA256SUMS-opencardev.txt >> release_notes.md
          echo '\`\`\`' >> release_notes.md
          echo >> release_notes.md
          echo "## Package versions" >> release_notes.md
          echo >> release_notes.md
          if [ -n "${{ steps.versions.outputs.libaasdk }}" ] || [ -n "${{ steps.versions.outputs.openauto }}" ]; then
            echo "- libaasdk: ${{ steps.versions.outputs.libaasdk || 'n/a' }}" >> release_notes.md
            echo "- openauto: ${{ steps.versions.outputs.openauto || 'n/a' }}" >> release_notes.md
          else
            echo "- libaasdk: armhf ${{ steps.pkgver.outputs.libaasdk_armhf }}, arm64 ${{ steps.pkgver.outputs.libaasdk_arm64 }}" >> release_notes.md
            echo "- openauto: armhf ${{ steps.pkgver.outputs.openauto_armhf }}, arm64 ${{ steps.pkgver.outputs.openauto_arm64 }}" >> release_notes.md
          fi
          echo >> release_notes.md
          echo "## SBOM" >> release_notes.md
          echo >> release_notes.md
          echo "CycloneDX and SPDX SBOMs are attached for each image (generated by syft)." >> release_notes.md
          echo "If available, a package inventory (sbom-packages.txt) generated during the build is also attached." >> release_notes.md
          echo >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo >> release_notes.md
          echo "Follow the installation guide: ${install_doc_url}" >> release_notes.md
          echo >> release_notes.md
          if [ -f docs/CHANGELOG.md ]; then
            echo "## Changelog" >> release_notes.md
            echo >> release_notes.md
            # Include the whole changelog for simplicity
            sed 's/^/# /;1s/^# /\n/' docs/CHANGELOG.md >> release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.collect.outputs.tag }}
          name: ${{ steps.collect.outputs.name }}
          body_path: release_notes.md
          files: |
            release_assets/*
            ${{ steps.versions.outputs.sbom_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
